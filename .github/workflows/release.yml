name: Release

on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'The tag to associate to this release'
        required: true

jobs:

  build-application:
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, darwin-latest]
        
    steps: 
      - name: Checkout ctcast
        uses: actions/checkout@v2

      - name: Setup Node
        uses: actions/setup-node@v2.4.1
        with:
          node-version: 16
          
      - name: Install dependencies
        run: npm install
        
      - name: Build
        run: npm run make

      - name: List output
        run: ls -R
        
      - name: Create tgz archive      
        run: tar -cvzf ctcast-{{runner.os}}.tgz out/ctcast-*

      - name: Create Windows Installer
        if: runner.os == 'Windows'
        run:  |
          npm install -g electron-installer-windows
          electron-installer-windows --src out/ctcast-*/ --dest out/installers/
          ls out/installers/

      - name: Create artifact of archive and installers
        uses: actions/upload-artifact@v2
        with:
          name: release-{{runner.os}}
          path: |
            cast*.tgz
            out/installers/*
          
  publish:
    needs: build-application
    
    runs-on: ubuntu-latest

    permissions:
      contents: write
      
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v2
 
      - name: List artifacts
        run: ls -R
      
      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release-Linux/ctcast-*
            release-Windows/ctcast-*
            
          tag_name: ${{ github.event.inputs.release_tag }}
          
# Todo code sign
# https://www.electronforge.io/guides/code-signing/code-signing-macos
# https://www.electronforge.io/guides/code-signing/code-signing-windows
